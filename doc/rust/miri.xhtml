<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">
	<head>
		<title>Rust メモ: MIRI の使用方法</title>
		<link rel="stylesheet" href="style/base.css"/>
		<script src="../../lib/doc.js"></script>
		<script src="lib/base.js"></script>
	</head>
	<body>
		<header>
			<h1><doc-title/></h1>
		</header>
		<p>
<a href="https://github.com/rust-lang/miri">MIRI</a> は UB (<a href="https://doc.rust-lang.org/reference/behavior-considered-undefined.html">Undefineded Behavior</a>) の検出ツールである。 <br/>
<code>unsafe</code> を含む Rust コードの健全性の確認に使われる。
		</p>
		<aside class="normal">
			<p>名前の由来</p> 
			<p>
MIRI の名前はそれが Rust の中間表現である MIR (Rust's Mid-level Inter&#xAD;mediate Repre&#xAD;sen&#xAD;tation) の解釈プログラム (Interpreter) として動作する事に由来している。
			</p> 
		</aside>
		<section>
			<h1>現状と必要性</h1>
			<p>
2025 年現在、MIRI はまだ実験段階のためナイトリー版でのみ動作する。
			</p> <p>
とはいえ、<code>unsafe</code> なコードを扱う場合、筆者はこのツールはほぼ必須だと考えている。
			</p> <p>
なぜなら、健全性の問題は人間にとって盲点になるものが多い。また、不健全なコードはその時点では問題なく動作しても、将来的な Rust の更新の影響を受ける可能性がある。MIRI はそれらの予防にもなる。
			</p>
		</section> <section>
			<h1>実行方法</h1>
				<p>
それぞれ以下のコマンドから実行できる。
				</p>
			<section>
				<h2>インストール</h2>
<pre><code class="console">
<mark class="prompt">&gt;</mark> rustup +nightly component add miri
</code></pre>
			</section> <section>
				<h2>バイナリの実行</h2>
<pre><code class="console">
<mark class="prompt">&gt;</mark> cargo +nightly miri run
</code></pre>
			</section> <section>
				<h2>テストの実行</h2>
<pre><code class="console">
<mark class="prompt">&gt;</mark> cargo +nightly miri test
</code></pre>
			</section>
		</section> <section>
			<h1>検出精度</h1>
			<p>
実用的な範囲では十分な精度がある。
			</p> <p>
そのため、MIRI がエラーを検出した場合、そのコードはほぼ確実に不健全である。ただし、MIRI がエラーを検出しない場合でも、その API が確実に健全だとは言えない。なぜなら、UB になるパターンがテストされていないだけの可能性は常にある。
			</p>
		</section> <section>
			<h1>モデル</h1>
			<p>
2025 年現在、Rust の <code>unsafe</code> まわりにはまだ曖昧さが残っている。
			</p> <p>
これに対して、MIRI は二つのモデル <dfn id="sb">Stacked Borrows</dfn> と <dfn id="tb">Tree Borrows</dfn> を用意している。どちらでもメモリ安全性は守られるが、後者は制限がより少ない。既定は前者で、後者を試用する場合、環境変数 <code>MIRIFLAGS</code> に <code>-Zmiri-tree-borrows</code> を指定するとよい。
			</p>
		</section> <section>
			<h1>事例集</h1>
			<ul>
				<li>
<a href="ub_removed_item.xhtml">UB - 削除済のアイテムの利用</a>
				</li> <li>
<a href="ub_protected_item.xhtml">UB - 保護されたアイテムの削除</a>
				</li>
			</ul>
		</section>
	</body>
</html>
